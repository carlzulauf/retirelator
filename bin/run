#!/usr/bin/env ruby
require "pry"
require_relative "env.rb"
require "yaml"

if ARGV[0].blank?
  puts "Missing required path to simulation configuration"
  exit
end

SIM_SAVE_NAME = ARGV[1].presence || File.basename(ARGV[0], '.yml')
SIM_SAVE_PATH = File.join(ROOT_DIR, "simulations", File.basename(ARGV[0], '.yml'))
CREDENTIALS_PATH = File.join(ROOT_DIR, "config", "credentials.json")

FileUtils.mkdir_p(SIM_SAVE_PATH)
simulation = Retirelator.from_params YAML.load_file(ARGV[0])
puts "Saving initial simuation to #{SIM_SAVE_PATH}"
Retirelator.save(simulation, SIM_SAVE_PATH)
simulation.simulate!
puts "Saving completed simuation to #{SIM_SAVE_PATH}"
Retirelator.save(simulation, SIM_SAVE_PATH)

if File.exist?(CREDENTIALS_PATH)
  require "retirelator/google_sheet_writer"
  Retirelator::GoogleSheetWriter.new.write_simulation(simulation)
end
