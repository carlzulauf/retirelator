#!/usr/bin/env ruby
require "pry"
require_relative "env.rb"
require "yaml"

if ARGV[0].blank?
  puts "Missing required path to simulation configuration"
  exit
end

SIM_SAVE_NAME = File.basename(ARGV[0], '.yml')
SIM_SAVE_PATH = File.join(ROOT_DIR, "simulations", File.basename(ARGV[0], '.yml'), "runs")

FileUtils.mkdir_p(SIM_SAVE_PATH)
Retirelator.logger.level = Logger::FATAL
sim_params = YAML.load_file(ARGV[0])

# Retirelator.save_json(simulation, File.join(SIM_SAVE_PATH, "init-#{ULID.generate}")
positive = 0
count = 100
count.times do
  simulation = Retirelator.from_params(sim_params)
  id = ULID.generate
  print "#{id} (seed: #{simulation.noiser.seed.to_s.rjust(39)})"
  simulation.simulate!
  balance = simulation.accounts.map(&:balance).sum
  puts ". Accounts: #{simulation.to_currency(balance).rjust(20)}"
  positive += 1 if balance.positive?
  Retirelator.save_json(simulation, File.join(SIM_SAVE_PATH, "#{id}.json"))
end

puts "Positive #{((positive.to_f / count) * 100).round(2)}%"
